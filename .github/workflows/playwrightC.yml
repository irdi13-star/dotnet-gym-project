name: Playwright C# with Dashboard

on:
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 8,14 * 1-12 1-5'
  workflow_dispatch: {}

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  test:
    timeout-minutes: 20
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Build WebsiteGym.Web
        run: dotnet build WebsiteGym.Web/WebsiteGym.Web.csproj

      - name: Start WebsiteGym.Web
        run: |
          cd WebsiteGym.Web
          dotnet run &
          sleep 10
          curl http://localhost:5000

      - name: Restore PlaywrightTests.CSharp
        working-directory: PlaywrightTests.CSharp
        run: dotnet restore

      - name: Build PlaywrightTests.CSharp
        working-directory: PlaywrightTests.CSharp
        run: dotnet build --no-restore

      - name: Install Playwright browsers
        working-directory: PlaywrightTests.CSharp
        run: pwsh bin/Debug/net9.0/playwright.ps1 install --with-deps

      - name: Run Playwright tests
        working-directory: PlaywrightTests.CSharp
        run: dotnet test --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"
        continue-on-error: true

      - name: Stop WebsiteGym.Web
        if: always()
        run: |
          pkill -f "dotnet run" || true

      - name: Checkout gh-pages branch
        if: always()
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup report directory
        if: always()
        run: |
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          RUN_NUMBER="${{ github.run_number }}"
          REPORT_DIR="gh-pages/reports/${TIMESTAMP}_run-${RUN_NUMBER}"

          mkdir -p "${REPORT_DIR}"
          mkdir -p "${REPORT_DIR}/screenshots"
          mkdir -p "${REPORT_DIR}/traces"

          echo "REPORT_DIR=${REPORT_DIR}" >> $GITHUB_ENV
          echo "TIMESTAMP=${TIMESTAMP}" >> $GITHUB_ENV
          echo "RUN_NUMBER=${RUN_NUMBER}" >> $GITHUB_ENV

      - name: Copy test results to gh-pages
        if: always()
        run: |
          if [ -f "PlaywrightTests.CSharp/bin/Debug/net9.0/test-results/extent-report.html" ]; then
            cp PlaywrightTests.CSharp/bin/Debug/net9.0/test-results/extent-report.html \
               "${REPORT_DIR}/index.html"
            echo "âœ… Extent report copied"
          else
            echo "âš ï¸ Extent report not found"
          fi

          if [ -d "PlaywrightTests.CSharp/bin/Debug/net9.0/test-results/screenshots" ]; then
            cp -r PlaywrightTests.CSharp/bin/Debug/net9.0/test-results/screenshots/* \
               "${REPORT_DIR}/screenshots/" 2>/dev/null || true
            echo "âœ… Screenshots copied"
          fi

          if [ -d "PlaywrightTests.CSharp/bin/Debug/net9.0/test-results/traces" ]; then
            cp -r PlaywrightTests.CSharp/bin/Debug/net9.0/test-results/traces/* \
               "${REPORT_DIR}/traces/" 2>/dev/null || true
            echo "âœ… Traces copied"
          fi

      - name: Rewrite screenshot paths in Extent report
        if: always()
        run: |
          REPORT_HTML="${REPORT_DIR}/index.html"

          if [ -f "$REPORT_HTML" ]; then
            echo "ðŸ”§ Rewriting screenshot paths..."

            sed -i 's#file:///home/runner/work/[^"]*/test-results/screenshots/#screenshots/#g' "$REPORT_HTML"
            sed -i 's#/home/runner/work/[^"]*/test-results/screenshots/#screenshots/#g' "$REPORT_HTML"

            echo "âœ… Screenshot paths rewritten"
          fi

      - name: Extract test statistics
        if: always()
        run: |
          REPORT_HTML="${REPORT_DIR}/index.html"
          TRX_FILE="PlaywrightTests.CSharp/TestResults/test-results.trx"

          # Default values - IMPORTANT: Must be numbers!
          TOTAL=0
          PASSED=0
          FAILED=0
          SKIPPED=0

          # Try to extract from TRX file
          if [ -f "$TRX_FILE" ]; then
            echo "ðŸ“Š Parsing TRX file..."
            
            # Extract and ensure we have valid numbers
            TOTAL_RAW=$(grep -oP 'total="\K\d+' "$TRX_FILE" | head -1)
            PASSED_RAW=$(grep -oP 'passed="\K\d+' "$TRX_FILE" | head -1)
            FAILED_RAW=$(grep -oP 'failed="\K\d+' "$TRX_FILE" | head -1)
            SKIPPED_RAW=$(grep -oP 'skipped="\K\d+' "$TRX_FILE" | head -1)
            
            # Assign with default fallback
            TOTAL=${TOTAL_RAW:-0}
            PASSED=${PASSED_RAW:-0}
            FAILED=${FAILED_RAW:-0}
            SKIPPED=${SKIPPED_RAW:-0}
            
            echo "Total: $TOTAL, Passed: $PASSED, Failed: $FAILED, Skipped: $SKIPPED"
          fi

          # Fallback: try to parse HTML if TRX failed
          if [ "$TOTAL" -eq 0 ] && [ -f "$REPORT_HTML" ]; then
            echo "ðŸ“Š Parsing HTML report as fallback..."
            PASSED=$(grep -oP 'Passed.*?(\d+)' "$REPORT_HTML" | grep -oP '\d+' | head -1 || echo "0")
            FAILED=$(grep -oP 'Failed.*?(\d+)' "$REPORT_HTML" | grep -oP '\d+' | head -1 || echo "0")
            SKIPPED=$(grep -oP 'Skipped.*?(\d+)' "$REPORT_HTML" | grep -oP '\d+' | head -1 || echo "0")
            TOTAL=$((PASSED + FAILED + SKIPPED))
          fi

          # Calculate pass rate
          if [ "$TOTAL" -gt 0 ]; then
            PASS_RATE=$(awk "BEGIN {printf \"%.1f\", ($PASSED * 100) / $TOTAL}")
          else
            PASS_RATE="0.0"
          fi

          echo "Final stats - Total: $TOTAL, Passed: $PASSED, Failed: $FAILED, Skipped: $SKIPPED, Pass Rate: $PASS_RATE%"

          # Generate valid JSON - NO TRAILING SPACES!
          cat > "${REPORT_DIR}/metadata.json" << EOF
          {
            "timestamp": "${TIMESTAMP}",
            "runNumber": ${RUN_NUMBER},
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "actor": "${{ github.actor }}",
            "total": ${TOTAL},
            "passed": ${PASSED},
            "failed": ${FAILED},
            "skipped": ${SKIPPED},
            "passRate": ${PASS_RATE}
          }
          EOF

          echo "âœ… Metadata saved"
          echo "ðŸ“„ Metadata contents:"
          cat "${REPORT_DIR}/metadata.json"

      - name: Clean old reports
        if: always()
        run: |
          cd gh-pages/reports
          
          echo "ðŸ—‘ï¸ Cleaning old reports (older than 14 days)..."
          DELETED=0
          
          for dir in */; do
            if [ -d "$dir" ]; then
              # Check if directory is older than 14 days
              AGE=$(find "$dir" -maxdepth 0 -mtime +14)
              if [ ! -z "$AGE" ]; then
                echo "Deleting: $dir"
                rm -rf "$dir"
                DELETED=$((DELETED + 1))
              fi
            fi
          done
          
          echo "Deleted $DELETED old report(s)"

      - name: Update reports index
        if: always()
        run: |
          cd gh-pages/reports

          # Initialize index.json if doesn't exist
          if [ ! -f index.json ]; then
            echo "[]" > index.json
          fi

          echo "ðŸ“‚ Scanning reports directory..."

          python3 << 'PYTHON_SCRIPT'
          import os
          import json

          reports_dir = "."
          reports = []

          print("ðŸ“‚ Scanning reports directory...")

          for item in os.listdir(reports_dir):
              report_path = os.path.join(reports_dir, item)
              metadata_path = os.path.join(report_path, "metadata.json")

              if not os.path.isdir(report_path) or not os.path.exists(metadata_path):
                  continue

              try:
                  with open(metadata_path, 'r') as f:
                      content = f.read()
                      metadata = json.loads(content)
                      metadata['path'] = item
                      reports.append(metadata)
                      print(f"âœ… Added report: {item}")
              except json.JSONDecodeError as e:
                  print(f"âš ï¸  Skipping {item}: Invalid JSON - {e}")
                  print(f"    Content preview: {content[:200] if 'content' in locals() else 'N/A'}")
              except Exception as e:
                  print(f"âš ï¸  Skipping {item}: {e}")

          reports.sort(key=lambda x: x.get('runNumber', 0), reverse=True)

          with open('index.json', 'w') as f:
              json.dump(reports, f, indent=2)

          print(f"âœ… Updated index with {len(reports)} reports")
          PYTHON_SCRIPT

          echo "ðŸ“„ Index contents:"
          cat index.json

      - name: Configure git
        if: always()
        run: |
          cd gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push changes
        if: always()
        run: |
          cd gh-pages
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add test report for run #${{ github.run_number }} - $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin gh-pages
            echo "âœ… Changes pushed to gh-pages"
          fi

      - name: Upload test results artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-run-${{ github.run_number }}
          path: |
            PlaywrightTests.CSharp/bin/Debug/net9.0/test-results/
            PlaywrightTests.CSharp/TestResults/
          retention-days: 7