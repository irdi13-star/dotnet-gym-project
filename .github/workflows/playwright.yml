name: Playwright Tests

on:
  pull_request:
    branches: [ main ]

jobs:
  runTestsOnCI:
    timeout-minutes: 20
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 'lts/*'

    - name: Restore .NET dependencies
      run: dotnet restore

    - name: Build .NET application (local)
      run: |
        if [ "$ACT" = "true" ]; then
          dotnet build --configuration Debug
        else
          echo "Skipping local build"
        fi

    - name: Start .NET application
      working-directory: WebsiteGym.Web
      run: |
        ASPNETCORE_URLS=http://0.0.0.0:5000 dotnet run &
        echo $! > app.pid

    - name: Wait for application
      run: |
        for i in {1..30}; do
          if curl -s http://localhost:5000 > /dev/null; then
            echo "Application is ready!"
            exit 0
          fi
          echo "Waiting for application... ($i/30)"
          sleep 1
        done
        echo "Application failed to start"
        exit 1

    - name: Install Playwright dependencies
      working-directory: PlaywrightTests
      run: |
        npm install

        if [ "$ACT" != "true" ]; then
          npx playwright install --with-deps
        else
          echo "Skipping playwright install (local run)"
        fi

    - name: Run Playwright tests
      working-directory: PlaywrightTests
      run: |
        if [ "$ACT" = "true" ]; then
          echo "Running LOCAL Playwright tests"
          npx playwright test --workers=1 --grep @@home
        else
          echo "Running CI Playwright tests"
          npx playwright test
        fi
      env:
        BASE_URL: http://localhost:5000

    - name: Ensure playwright-report directory exists
      run: mkdir -p PlaywrightTests/playwright-report/

    - name: Upload HTML report as artifact
      if: ${{ env.ACT != 'true' }}
      uses: actions/upload-artifact@v4
      with:
       name: playwright-report
       path: ./PlaywrightTests/playwright-report/
       retention-days: 30

    - name: Stop .NET application
      if: always()
      working-directory: WebsiteGym.Web
      run: |
        if [ -f app.pid ]; then
          kill $(cat app.pid) || true
        fi
