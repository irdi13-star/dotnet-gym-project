name: Playwright Tests

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  runTestsOnCI:
    timeout-minutes: 20
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 'lts/*'

    - name: Restore .NET dependencies
      run: dotnet restore

    - name: Build .NET application
      run: dotnet build --configuration Release WebsiteGym.Web/WebsiteGym.Web.csproj

    - name: Debug - Check build output
      run: |
        echo "üì¶ Checking build artifacts..."
        ls -la WebsiteGym.Web/bin/Release/net*/
        
        echo "üìÑ Checking for database..."
        find . -name "*.db" -type f

    - name: Start .NET application
      run: |
        cd WebsiteGym.Web
        
        # Set environment variables
        export ASPNETCORE_URLS=http://0.0.0.0:5000
        export ASPNETCORE_ENVIRONMENT=Development
        
        # Start application in background
        dotnet run --no-build --configuration Release > app.log 2>&1 &
        APP_PID=$!
        echo $APP_PID > app.pid
        
        echo "üöÄ Started application with PID: $APP_PID"
        
        # Give it a moment to start
        sleep 3
        
        # Check if process is still running
        if ps -p $APP_PID > /dev/null; then
          echo "‚úÖ Application process is running"
        else
          echo "‚ùå Application process died immediately"
          echo "üìÑ Application logs:"
          cat app.log
          exit 1
        fi

    - name: Wait for application with detailed logging
      run: |
        echo "‚è≥ Waiting for application to be ready..."
        
        for i in {1..30}; do
          # Try to curl
          if curl -s -f http://localhost:5000 > /dev/null 2>&1; then
            echo "‚úÖ Application is ready!"
            echo "üìä Application info:"
            curl -s http://localhost:5000 | head -n 5
            exit 0
          fi
          
          # Check if process is still running
          if [ -f WebsiteGym.Web/app.pid ]; then
            APP_PID=$(cat WebsiteGym.Web/app.pid)
            if ! ps -p $APP_PID > /dev/null 2>&1; then
              echo "‚ùå Application process died!"
              echo "üìÑ Application logs:"
              cat WebsiteGym.Web/app.log
              exit 1
            fi
          fi
          
          echo "‚è±Ô∏è  Waiting for application... ($i/30)"
          sleep 1
        done
        
        echo "‚ùå Application failed to start within 30 seconds"
        echo "üìÑ Application logs:"
        cat WebsiteGym.Web/app.log
        
        # Check what's listening on port 5000
        echo "üì° Checking port 5000:"
        netstat -tulpn | grep 5000 || echo "Nothing listening on 5000"
        
        exit 1

    - name: Install Playwright dependencies
      working-directory: PlaywrightTests
      run: |
        npm ci
        
        if [ "$ACT" = "true" ]; then
          echo "üê≥ Running in act - installing only Chromium"
          npx playwright install chromium --with-deps
        else
          echo "‚òÅÔ∏è Running in GitHub Actions - installing all browsers"
          npx playwright install --with-deps
        fi

    - name: Run Playwright tests
      working-directory: PlaywrightTests
      run: |
        if [ "$ACT" = "true" ]; then
          echo "üê≥ Running LOCAL Playwright tests (limited)"
          npx playwright test --workers=1 --project=chromium --grep @home
        else
          echo "‚òÅÔ∏è Running FULL Playwright tests"
          npx playwright test
        fi
      env:
        BASE_URL: http://localhost:5000

    - name: Upload test results
      if: always() && env.ACT != 'true'
      uses: actions/upload-artifact@v4
      with:
       name: playwright-report
       path: PlaywrightTests/playwright-report/
       retention-days: 30

    - name: Stop .NET application
      if: always()
      run: |
        if [ -f WebsiteGym.Web/app.pid ]; then
          APP_PID=$(cat WebsiteGym.Web/app.pid)
          echo "üõë Stopping application (PID: $APP_PID)"
          kill $APP_PID || true
          
          # Wait a bit and force kill if needed
          sleep 2
          if ps -p $APP_PID > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  Force killing application"
            kill -9 $APP_PID || true
          fi
        fi
        
        # Also kill by name just in case
        pkill -f "dotnet.*WebsiteGym.Web" || true